From c2c3a051b96614d899cd2fb9b29e000a670a8066 Mon Sep 17 00:00:00 2001
From: Willem Lee <1980490718@qq.com>
Date: Sat, 27 Sep 2025 22:04:51 +0800
Subject: [PATCH] mtd: spinand: add support for FudanMicro FM25G02B

---
 drivers/mtd/nand/spi/fmsh.c | 36 ++++++++++++++++++++++++++++++++++++
 1 file changed, 36 insertions(+)

diff --git a/drivers/mtd/nand/spi/fmsh.c b/drivers/mtd/nand/spi/fmsh.c
index 71922d94f..5ae24b659 100644
--- a/drivers/mtd/nand/spi/fmsh.c
+++ b/drivers/mtd/nand/spi/fmsh.c
@@ -159,6 +159,33 @@
 		return -EBADMSG;
 }
 
+static int fm25g02b_ooblayout_ecc(struct mtd_info *mtd, int section,
+				  struct mtd_oob_region *region)
+{
+	if (section >= 8)
+		return -ERANGE;
+	region->offset = 64 + section * 8;
+	region->length = 8;
+
+	return 0;
+}
+
+static int fm25g02b_ooblayout_free(struct mtd_info *mtd, int section,
+				   struct mtd_oob_region *region)
+{
+	if (section)
+		return -ERANGE;
+	region->offset = 2;
+	region->length = 62;
+
+	return 0;
+}
+
+static const struct mtd_ooblayout_ops fm25g02b_ooblayout = {
+	.ecc = fm25g02b_ooblayout_ecc,
+	.free = fm25g02b_ooblayout_free,
+};
+
 static const struct spinand_info fmsh_spinand_table[] = {
 	SPINAND_INFO("FM25S01A",
 		     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xE4),
@@ -169,6 +196,15 @@
 					      &update_cache_variants),
 		     0,
 		     SPINAND_ECCINFO(&fm25s01a_ooblayout, NULL)),
+	SPINAND_INFO("FM25G02B",
+		     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xD2),
+		     NAND_MEMORG(1, 2048, 128, 64, 2048, 40, 1, 1, 1),
+		     NAND_ECCREQ(8, 528),
+		     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,
+					      &write_cache_variants,
+					      &update_cache_variants),
+		     SPINAND_HAS_QE_BIT,
+		     SPINAND_ECCINFO(&fm25g02b_ooblayout, NULL)),
 	SPINAND_INFO("FM25S02A",
 		     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xE5),
 		     NAND_MEMORG(1, 2048, 64, 64, 2048, 40, 2, 1, 1),
-- 
2.25.1

